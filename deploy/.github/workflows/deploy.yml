name: ğŸš€ Auto Deploy to Server

on:
  push:
    branches:
      - master
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v3

      - name: ğŸ” é…ç½® SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: âœ… æ£€æŸ¥ SSH è¿æ¥
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H 47.100.82.151 >> ~/.ssh/known_hosts
          ssh root@47.100.82.151 "echo 'âœ… SSH è¿æ¥æˆåŠŸ'"

      - name: ğŸš€ æ‰§è¡Œè¿œç¨‹éƒ¨ç½²
        run: |
          ssh root@47.100.82.151 << 'EOF'
          #!/bin/bash
          set -e
          
          echo "========== GitHub Actions è‡ªåŠ¨éƒ¨ç½² =========="
          cd /var/www/my-next-app
          
          echo "[1/7] æ‹‰å–æœ€æ–°ä»£ç ..."
          git fetch origin
          git reset --hard origin/master || git reset --hard origin/main
          
          echo "[2/7] å®‰è£…æ–°ä¾èµ–..."
          npm install
          
          echo "[3/7] æ„å»ºé¡¹ç›®..."
          npm run build
          
          echo "[4/7] é‡å¯ PM2 åº”ç”¨..."
          pm2 stop my-next-app || true
          pm2 start ecosystem.config.cjs --env production
          
          echo "[5/7] ä¿å­˜ PM2 é…ç½®..."
          pm2 save
          
          echo "[6/7] æ¸…ç† Nginx ç¼“å­˜..."
          sudo rm -rf /var/cache/nginx/*
          
          echo "[7/7] é‡è½½ Nginx..."
          sudo nginx -t && sudo systemctl reload nginx
          
          echo ""
          echo "========== éƒ¨ç½²å®Œæˆï¼=========="
          echo "åº”ç”¨çŠ¶æ€:"
          pm2 status
          
          echo ""
          echo "ğŸ“Š éƒ¨ç½²ç»Ÿè®¡:"
          echo "- æäº¤è€…: ${{ github.actor }}"
          echo "- æäº¤ä¿¡æ¯: ${{ github.event.head_commit.message }}"
          echo "- æäº¤ SHA: ${{ github.sha }}"
          echo "- éƒ¨ç½²æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          EOF

      - name: ğŸ“§ å‘é€é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            âœ… éƒ¨ç½²æˆåŠŸï¼
            åˆ†æ”¯: ${{ github.ref_name }}
            æäº¤: ${{ github.event.head_commit.message }}
            ä½œè€…: ${{ github.actor }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        continue-on-error: true

      - name: ğŸ“§ éƒ¨ç½²å¤±è´¥é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            âŒ éƒ¨ç½²å¤±è´¥ï¼
            åˆ†æ”¯: ${{ github.ref_name }}
            æäº¤: ${{ github.event.head_commit.message }}
            ä½œè€…: ${{ github.actor }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        continue-on-error: true
